<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
    <head>
        <title>User Message.</title>
        <script src="/js/sockjs-0.3.4.js"></script>
        <script src="/js/stomp.js"></script>
        <script type="text/javascript">
            var stompClient = null;
            function setConnected(connected) {
                document.getElementById('disconnect').disabled = !connected;
                document.getElementById('response').innerHTML = '';
            }

            function connect() {
                var socket = new SockJS('/hello');
                stompClient = Stomp.over(socket);
                stompClient.connect({}, function(frame) {
                    setConnected(true);
                    console.log('Connected: ' + frame);
                    stompClient.subscribe('/topic/greetings', function(message){
                        showMessage(JSON.parse(message.body).text);
                    });
                });
            }

            function disconnect() {
                if (stompClient != null) {
                    stompClient.disconnect();
                }
                setConnected(false);
                console.log("Disconnected");
            }
            function showMessage(message) {
                var response = document.getElementById('response');
                var p = document.createElement('p');
                p.style.wordWrap = 'break-word';
                p.appendChild(document.createTextNode(message));
                response.appendChild(p);
            }
            </script>

    </head>
    <body onload="connect()">

        <a th:href="@{index}" id="disconnect" onclick="disconnect();"><span>Disconnect</span></a>
    <h1 th:inline="text">Hello [[${#httpServletRequest.remoteUser}]]!</h1>
        <form th:action="@{/logout}" method="post">
            <input type="submit" value="Sign Out"/>
        </form>
    </body>
</html>
